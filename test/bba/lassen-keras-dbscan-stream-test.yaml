title: BBA integration test
resource: llnl.lassen
queue: pbatch
schema_: local
project: cv19-a01
walltime_min: 30
max_iteration: 4
cpus_per_node: 40
gpus_per_node: 4
hardware_threads_per_cpu: 4
experiment_directory: /usr/workspace/cv_ddmd/yakushin/Integration1/Outputs/1
node_local_path: null
molecular_dynamics_stage:
    pre_exec:
    - unset PYTHONPATH
    - module load gcc/7.3.1
    - . /etc/profile.d/conda.sh
    - conda activate /usr/workspace/cv_ddmd/conda1/powerai
    - export IBM_POWERAI_LICENSE_ACCEPT=yes
    - module use /usr/workspace/cv_ddmd/software1/modules
    - module load adios2
    - export PYTHONPATH=/usr/workspace/cv_ddmd/yakushin/Integration1/DeepDriveMD-pipeline/deepdrivemd/misc/:/usr/workspace/cv_ddmd/software1/ADIOS2/lib/python3.6/site-packages/
    executable: '/usr/workspace/cv_ddmd/conda1/powerai/bin/python'
    arguments:
    - /usr/workspace/cv_ddmd/yakushin/Integration1/DeepDriveMD-pipeline/deepdrivemd/sim/openmm_stream/run_openmm.py
    cpu_reqs:
        processes: 1
        process_type: null
        threads_per_process: 4
        thread_type: OpenMP
    gpu_reqs:
        processes: 1
        process_type: null
        threads_per_process: 1
        thread_type: CUDA
    num_tasks: 12
    task_config:
        experiment_directory: set_by_deepdrivemd
        stage_idx: 0
        task_idx: 0
        output_path: set_by_deepdrivemd
        node_local_path: set_by_deepdrivemd
        pdb_file: set_by_deepdrivemd
        initial_pdb_dir: /usr/workspace/cv_ddmd/yakushin/Integration1/data/bba/ddmd_input
        solvent_type: implicit
        top_suffix: null
        simulation_length_ns: 1.0
        report_interval_ps: 1.0
        dt_ps: 0.002
        temperature_kelvin: 310.0
        heat_bath_friction_coef: 1.0
        wrap: false
        reference_pdb_file: /usr/workspace/cv_ddmd/yakushin/Integration1/data/bba/ddmd_reference/1FME.pdb
        openmm_selection:
        - CA
        mda_selection: protein and name CA
        threshold: 8.0
        contact_map: true
        point_cloud: false
        fraction_of_contacts: false
        in_memory: false
        bp_file: set_by_deepdrivemd
        adios_cfg: /usr/workspace/cv_ddmd/yakushin/Integration1/DeepDriveMD-pipeline/deepdrivemd/sim/openmm_stream/adios.xml
        outliers_dir: /usr/workspace/cv_ddmd/yakushin/Integration1/Outputs/1/agent_runs/stage0000/task0000/published_outliers
        copy_velocities_p: 0.5
        next_outlier_policy: 1
        lock: set_by_deepdrivemd
aggregation_stage:
    pre_exec:
    - module load gcc/7.3.1
    - . /etc/profile.d/conda.sh
    - conda activate /usr/workspace/cv_ddmd/conda1/powerai
    - module use /usr/workspace/cv_ddmd/software1/modules
    - module load adios2
    - export PYTHONPATH=/usr/workspace/cv_ddmd/yakushin/Integration1/DeepDriveMD-pipeline/deepdrivemd/misc/:/usr/workspace/cv_ddmd/software1/ADIOS2/lib/python3.6/site-packages/
    executable: '/usr/workspace/cv_ddmd/conda1/powerai/bin/python'
    arguments: 
    - /usr/workspace/cv_ddmd/yakushin/Integration1/DeepDriveMD-pipeline/deepdrivemd/aggregation/stream/aggregator.py
    cpu_reqs:
        processes: 1
        process_type: null
        threads_per_process: 4
        thread_type: 'OpenMP'
    gpu_reqs:
        processes: 0
        process_type: null
        threads_per_process: 0
        thread_type: null
    skip_aggregation: false
    num_tasks: 2
    task_config:
        experiment_directory: set_by_deepdrivemd
        stage_idx: 0
        task_idx: 0
        output_path: set_by_deepdrivemd
        node_local_path: set_by_deepdrivemd
        num_tasks: 2
        n_sim: 12
        sleeptime_bpfiles: 30
machine_learning_stage:
    pre_exec:
    - module load gcc/7.3.1
    - . /etc/profile.d/conda.sh
    - conda activate /usr/workspace/cv_ddmd/conda1/powerai
    - module use /usr/workspace/cv_ddmd/software1/modules
    - module load adios2
    - export PYTHONPATH=/usr/workspace/cv_ddmd/yakushin/Integration1/DeepDriveMD-pipeline/deepdrivemd/misc/:/usr/workspace/cv_ddmd/software1/ADIOS2/lib/python3.6/site-packages/
    executable: '/usr/workspace/cv_ddmd/conda1/powerai/bin/python'
    arguments:
    - /usr/workspace/cv_ddmd/yakushin/Integration1/DeepDriveMD-pipeline/deepdrivemd/models/keras_cvae_stream/train.py
    cpu_reqs:
        processes: 1
        process_type: MPI
        threads_per_process: 4
        thread_type: OpenMP
    gpu_reqs:
        processes: 1
        process_type: null
        threads_per_process: 1
        thread_type: CUDA
    task_config:
        experiment_directory: set_by_deepdrivemd
        stage_idx: 0
        task_idx: 0
        output_path: set_by_deepdrivemd
        node_local_path: set_by_deepdrivemd
        model_tag: set_by_deepdrivemd
        init_weights_path: null
        dataset_name: contact_map
        initial_shape:
        - 28
        - 28
        final_shape:
        - 28
        - 28
        - 1
        initial_epochs: 5
        epochs: 5
        batch_size: 32
        split_pct: 0.8
        shuffle: true
        latent_dim: 10
        conv_layers: 4
        conv_filters:
        - 64
        - 64
        - 64
        - 64
        conv_filter_shapes:
        -   - 3
            - 3
        -   - 3
            - 3
        -   - 3
            - 3
        -   - 3
            - 3
        conv_strides:
        -   - 1
            - 1
        -   - 2
            - 2
        -   - 1
            - 1
        -   - 1
            - 1
        dense_layers: 1
        dense_neurons:
        - 128
        dense_dropouts:
        - 0.25
        min_step_increment: 50
        max_steps: 8000
        max_loss: 10000
        num_agg: 2
        timeout1: 30
        timeout2: 10
        agg_dir: /usr/workspace/cv_ddmd/yakushin/Integration1/Outputs/1/aggregation_runs/
        published_model_dir: set_by_deepdrivemd
        checkpoint_dir: set_by_deepdrivemd
        adios_xml: /usr/workspace/cv_ddmd/yakushin/Integration1/DeepDriveMD-pipeline/deepdrivemd/aggregation/stream/adios.xml
agent_stage:
    pre_exec:
    - module load gcc/7.3.1
    - . /etc/profile.d/conda.sh
    - conda activate /usr/workspace/cv_ddmd/conda1/powerai
    - module use /usr/workspace/cv_ddmd/software1/modules
    - module load adios2
    - export PYTHONPATH=/usr/workspace/cv_ddmd/yakushin/Integration1/DeepDriveMD-pipeline/deepdrivemd/misc/:/usr/workspace/cv_ddmd/software1/ADIOS2/lib/python3.6/site-packages/
    executable: '/usr/workspace/cv_ddmd/conda1/powerai/bin/python'
    arguments:
    - /usr/workspace/cv_ddmd/yakushin/Integration1/DeepDriveMD-pipeline/deepdrivemd/agents/stream/dbscan.py
    cpu_reqs:
        processes: 1
        process_type: null
        threads_per_process: 12
        thread_type: OpenMP
    gpu_reqs:
        processes: 1
        process_type: null
        threads_per_process: 1
        thread_type: CUDA
    task_config:
        experiment_directory: set_by_deepdrivemd
        stage_idx: 0
        task_idx: 0
        output_path: set_by_deepdrivemd
        node_local_path: set_by_deepdrivemd
        num_intrinsic_outliers: 100
        num_extrinsic_outliers: 12
        intrinsic_score: dbscan
        extrinsic_score: rmsd
        n_traj_frames: 1000
        n_most_recent_h5_files: 12
        k_random_old_h5_files: 12
        sklearn_num_jobs: -1
        model_type: "keras_cvae"
        inference_batch_size: 1024

        agg_dir: /usr/workspace/cv_ddmd/yakushin/Integration1/Outputs/1/aggregation_runs
        num_agg: 2
        min_step_increment: 500
        timeout1: 30
        timeout2: 10
        best_model: /usr/workspace/cv_ddmd/yakushin/Integration1/Outputs/1/machine_learning_runs/stage0000/task0000/published_model/best.h5
        lastN: 2000

        dense_layers: 1
        conv_layers: 4
        conv_strides:
        -   - 1
            - 1
        -   - 2
            - 2
        -   - 1
            - 1
        -   - 1
            - 1
        dense_dropouts:
        - 0.25
        conv_filters:
        - 64
        - 64
        - 64
        - 64
        initial_shape:
        - 28
        - 28
        conv_filter_shapes:
        -   - 3
            - 3
        -   - 3
            - 3
        -   - 3
            - 3
        -   - 3
            - 3
        latent_dim: 10
        final_shape:
        - 28
        - 28
        - 1
        dense_neurons:
        - 128

        best_model: /usr/workspace/cv_ddmd/yakushin/Integration1/Outputs/1/machine_learning_runs/stage0000/task0000/published_model/best.h5
        outlier_count: 120
        outlier_max: 500
        outlier_min: 100
        init_pdb_file: /usr/workspace/cv_ddmd/yakushin/Integration1/data/bba/ddmd_input/1FME-0.pdb
        ref_pdb_file: /usr/workspace/cv_ddmd/yakushin/Integration1/data/bba/ddmd_reference/1FME.pdb
        n_workers: 4
        init_eps: 1.3

        adios_xml: /usr/workspace/cv_ddmd/yakushin/Integration1/DeepDriveMD-pipeline/deepdrivemd/aggregation/stream/adios.xml
        batch: 10000
